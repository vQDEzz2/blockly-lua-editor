<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Blockly Example</title>
    <!-- Blockly Core -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <!-- Optional: Use specific language generators -->
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly/lua_compressed.js"></script>
    <style>
        body {
            margin: 0;
            max-width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        #blocklyArea {
            flex-grow: 1;
            display: flex;
        }
        #blocklyDiv {
            flex-grow: 1;
            height: 100%;
        }
        #outputArea {
            height: 200px;
            overflow: auto;
            padding: 1em;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div>
        <button onclick="generateCode('JavaScript')">Generate JavaScript</button>
        <button onclick="generateCode('Python')">Generate Python</button>
        <button onclick="generateCode('Lua')">Generate Lua</button>
        <button onclick="runCode()">Run JavaScript</button>
    </div>
    <div id="blocklyArea">
        <div id="blocklyDiv"></div>
    </div>
    <div id="outputArea">
        <pre id="codeOutput"></pre>
        <hr>
        <div id="output"></div>
    </div>

    <!-- Toolbox Definition -->
    <xml id="toolbox" style="display: none">
        <category name="Logic" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Loops" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="TO">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <value name="BY">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Math" colour="%{BKY_MATH_HUE}">
            <block type="math_number">
                <field name="NUM">123</field>
            </block>
            <block type="math_arithmetic">
                <value name="A">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="B">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="math_single">
                <value name="NUM">
                    <shadow type="math_number">
                        <field name="NUM">9</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="Text" colour="%{BKY_TEXTS_HUE}">
            <block type="text"></block>
            <block type="text_print"></block>
            <block type="text_length"></block>
            <block type="text_join"></block>
        </category>
        <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
        </category>
        <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
        </category>
    </xml>

    <script>
        // Initialize Blockly workspace
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            grid: {
                spacing: 20,
                length: 3,
                colour: '#ccc',
                snap: true
            },
            zoom: {
                controls: true,
                wheel: true,
                startScale: 1.0,
                maxScale: 3,
                minScale: 0.3,
                scaleSpeed: 1.2
            },
            trashcan: true
        });

        // Generate code in selected language
        function generateCode(lang) {
            var code;
            switch(lang) {
                case 'JavaScript':
                    code = Blockly.JavaScript.workspaceToCode(workspace);
                    break;
                case 'Python':
                    code = Blockly.Python.workspaceToCode(workspace);
                    break;
                case 'Lua':
                    code = Blockly.Lua.workspaceToCode(workspace);
                    break;
                default:
                    code = 'Language not supported.';
            }
            document.getElementById('codeOutput').innerText = code;
        }

        // Run JavaScript code
        function runCode() {
            // Get generated code
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            
            // Create a function to capture outputs
            var outputArea = document.getElementById('output');
            var originalConsoleLog = console.log;
            console.log = function(msg) {
                outputArea.innerHTML += msg + '<br>';
                originalConsoleLog.apply(console, arguments);
            };
            
            // Clear previous output
            outputArea.innerHTML = '';
            
            try {
                eval(code);
            } catch (e) {
                console.log('Error: ' + e);
            }
            
            // Restore original console.log
            console.log = originalConsoleLog;
        }

        // Add workspace change listener for auto-generation
        workspace.addChangeListener(function(event) {
            if (event.type == Blockly.Events.CHANGE || 
                event.type == Blockly.Events.MOVE || 
                event.type == Blockly.Events.DELETE) {
                generateCode('JavaScript');
            }
        });
    </script>
</body>
</html>
